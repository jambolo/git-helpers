#!/usr/bin/env bash
#
# This bash script automates the creation of a new TypeScript node.js project with PNPM.

set -e  # Exit on error

if [ $# -ne 0 ]; then
    echo "Usage: pnpm-init-typescript"
    echo "Initializes a brand new TypeScript node.js project with PNPM"
    exit 1
fi

echo "*** Creating git repo ..."
git init
git commit --allow-empty -m "New repo"

echo
echo "*** Creating .gitignore ..."
npx gitignore node
cat >> .gitignore << 'EOF'
dist/

# Claude AI
.claude/

# VS Code
.vscode/
EOF
git add --all
git commit -m "Added TypeScript default .gitignore"

echo
echo "*** Creating MIT license ..."
npx license MIT
git add --all
git commit -m "Added MIT License"

echo
echo "*** Creating default README.md ..."
cat > README.md <<EOF
# $(basename "$PWD")
EOF
git add --all
git commit -m "Added default README.md"

echo
echo "*** Initializing node project using pnpm ..."
pnpm init
pnpm install
git add --all
git commit -m "Added default package.json and pnpm-lock.yaml"

echo
echo "*** Creating Github CI workflow ..."
mkdir -p .github/workflows
cat > .github/workflows/ci.yml << 'EOF'
name: Typescript Validation with pnpm

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test:run

      - name: Compile
        run: pnpm build
EOF
git add --all
git commit -m "Added Github CI workflow"

echo
echo "*** Installing TypeScript dependencies ..."
pnpm add --save-dev typescript @types/node tsx vitest

echo
echo "*** Creating tsconfig.json ..."
cat > tsconfig.json << 'EOF'
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "rootDir": "./src",
    "outDir": "./dist",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
EOF

echo
echo "*** Creating project structure ..."
mkdir -p src/lib  # git does not track empty directories; add files here as needed

echo
echo "*** Updating package.json scripts ..."
pnpm pkg set scripts.build="tsc"
pnpm pkg set scripts.test="vitest"
pnpm pkg set scripts.test:run="vitest --run"

echo
echo "*** Creating .vscode/launch.json ..."
mkdir -p .vscode
cat > .vscode/launch.json << 'EOF'
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Debug current file",
      "runtimeExecutable": "tsx",
      "runtimeArgs": ["${file}"],
      "skipFiles": ["<node_internals>/**"]
    }
  ]
}
EOF

git add --all
git commit -m "Added TypeScript configuration"
