#!/usr/bin/env bash
#
# Runs uncrustify on all modified and added c/cpp/h files in the working tree.

set -e  # Exit on error

if [ $# -ne 0 ]; then
    echo "Usage: git-uncrustify"
    echo "Runs uncrustify on all modified and added c/cpp/h files in the working tree."
    exit 1;
fi

# Run from the root of the git repository
ROOT_DIR=$(git rev-parse --show-toplevel)
cd "$ROOT_DIR"

UNCRUSTIFY_EXE="/c/Program Files (x86)/uncrustify/uncrustify.exe"
CONFIG_FILE="$HOME/AppData/Roaming/Uncrustify/uncrustify.cfg"

if [ ! -x "$UNCRUSTIFY_EXE" ]; then
    echo "Error: uncrustify executable not found at $UNCRUSTIFY_EXE"
    exit 2
fi

FILES=$(git diff --name-only --diff-filter=AM | grep -E '\.(c|cpp|h)$')

if [ -z "$FILES" ]; then
    echo "No modified or added C/C++/header files found."
    exit 0
fi

for file in $FILES; do
    "$UNCRUSTIFY_EXE" --no-backup -l CPP -c "$CONFIG_FILE" "$file"
done
