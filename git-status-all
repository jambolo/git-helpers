#!/usr/bin/env bash
#
# Check the status of all git repositories in subdirectories.

set -e  # Exit on error

# Initialize counters:
count_all=0
count_changed=0
count_unchanged=0

# Set to 1 for more verbose output:
verbose=0

# Parse verbose flag
if [[ "$1" == "-v" || "$1" == "--verbose" ]]; then
    verbose=1
fi

# Help option
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "Usage: git-status-all [-v|--verbose] [-h|--help]"
    echo "Checks all git repositories in subdirectories and lists those with changes."
    echo "  -v, --verbose   Show unchanged repositories."
    echo "  -h, --help      Show this help message."
    exit 0
fi

# Find git repos and loop over them:
while read -d $'\0' repo; do
    ((count_all++)) || true

    dir=$(echo "${repo}" | sed -e 's/\/.git$//')
    pushd "${dir}" > /dev/null

    # If there are changes, print some status and branch info of this repo:
    if git status -s | grep -v '??' &> /dev/null; then
        echo -e "\n\n \033[4;31m ${dir}\033[0m"
        git branch -vvra
        git status -s | grep -v '??'
        ((count_changed++)) || true
        echo
    else
        if [ ${verbose} -ne 0 ]; then echo "Nothing to do for ${dir}"; fi
        ((count_unchanged++)) || true
    fi

    popd > /dev/null
done < <(find . -type d -name ".git" -print0)

# Report status and exit:
echo -e "\n\n\033[1;34m${count_all} git repositories found:\033[0m \033[1;31m${count_changed} have changes\033[0m, \033[1;32m${count_unchanged} are unchanged.\033[0m\n"